<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Ordering System</title>
    <style>
        /* --- Styles unchanged from original, including delete-person-btn --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px; border-left: 5px solid #3498db; }
        .section h2 { color: #2c3e50; margin-bottom: 15px; font-size: 1.5em; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        input[type="text"], input[type="number"] { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; }
        input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: #3498db; }
        input[type="text"] { flex: 1; }
        input[type="number"] { width: 80px; }
        button { padding: 12px 20px; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: transform 0.2s ease; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52,152,219,0.4); }
        .main-content { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; margin-top: 20px; }
        .food-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .food-list::-webkit-scrollbar { width: 8px; }
        .food-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; border-radius: 10px; cursor: grab; user-select: none; transition: all 0.3s ease; }
        .food-name { font-weight: bold; font-size: 18px; }
        .food-quantity { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-weight: bold; min-width: 40px; text-align: center; }
        .delete-food-btn { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .people-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 20px; max-height: 500px; overflow-y: auto; padding-right: 10px; }
        .person-card { background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 3px dashed #ddd; transition: all 0.3s ease; position: relative; min-height: 200px; }
        .person-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .person-name { font-size: 1.4em; font-weight: bold; color: #2c3e50; }
        .delete-person-btn { background: rgba(231,76,60,0.8); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .person-orders { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: linear-gradient(45deg, #27ae60, #2ecc71); border-radius: 8px; color: white; }
        .order-quantity { background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 15px; min-width: 25px; text-align: center; }
        .remove-btn { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; }
        .complete-btn { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 8px; padding: 8px 16px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="status" class="status"></div>
    <div class="container">
        <h1>üçï Food Ordering System</h1>
        <div class="section">
            <h2>Add People</h2>
            <div class="input-group">
                <input type="text" id="personName" placeholder="Enter person's name" />
                <button onclick="addPerson()">Add Person</button>
            </div>
        </div>
        <div class="section">
            <h2>Add Food Items</h2>
            <div class="input-group">
                <input type="text" id="foodName" placeholder="Enter food name" />
                <input type="number" id="foodQuantity" min="1" value="1" />
                <button onclick="addFood()">Add Food</button>
            </div>
        </div>
        <div class="main-content">
            <div class="section">
                <h2>Available Food</h2>
                <div id="foodList" class="food-list"><div class="empty-state">No food items available</div></div>
            </div>
            <div class="section">
                <h2>People & Orders</h2>
                <div id="peopleGrid" class="people-grid"><div class="empty-state">No people added yet</div></div>
            </div>
        </div>
    </div>
    <script>
        let people = [];
        let foodItems = [];
        let draggedFood = null;

        async function apiCall(url, options = {}) {
            try {
                const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
                if (!res.ok) throw new Error(res.statusText);
                return await res.json();
            } catch (err) {
                showStatus(err.message, true);
                throw err;
            }
        }

        // Load initial data
        async function loadData() {
            showStatus('Loading data...');
            try {
                const data = await apiCall('/api/data');
                people = data.people || [];
                foodItems = data.foodItems || [];
                renderFood(); renderPeople(); showStatus('Data loaded');
            } catch {
                showStatus('Failed to load data', true);
            }
        }

        async function addPerson() {
            const name = document.getElementById('personName').value.trim();
            if (!name) return showStatus('Enter a name', true);
            showStatus('Adding person...');
            try {
                const result = await apiCall('/api/people', { method: 'POST', body: JSON.stringify({ name }) });
                people = result.data.people; foodItems = result.data.foodItems;
                document.getElementById('personName').value = '';
                renderPeople(); showStatus('Person added');
            } catch {
                showStatus('Failed to add person', true);
            }
        }

        async function addFood() {
            const name = document.getElementById('foodName').value.trim();
            const qty = parseInt(document.getElementById('foodQuantity').value, 10);
            if (!name || qty < 1) return showStatus('Enter valid food and qty', true);
            showStatus('Adding food...');
            try {
                const result = await apiCall('/api/food', { method: 'POST', body: JSON.stringify({ name, quantity: qty }) });
                people = result.data.people; foodItems = result.data.foodItems;
                document.getElementById('foodName').value = '';
                document.getElementById('foodQuantity').value = '1';
                renderFood(); showStatus('Food added');
            } catch {
                showStatus('Failed to add food', true);
            }
        }

        async function deleteFood(foodName) {
            if (!confirm(`Delete ${foodName}?`)) return;
            try {
                const result = await apiCall(`/api/food/${encodeURIComponent(foodName)}`, { method: 'DELETE' });
                people = result.data.people; foodItems = result.data.foodItems;
                renderFood(); renderPeople(); showStatus('Food deleted');
            } catch {
                showStatus('Failed to delete food', true);
            }
        }

        // Client-only remove person (restores their orders)
        function removePerson(personName) {
            if (!confirm(`Delete ${personName}?`)) return;
            const idx = people.findIndex(p => p.name === personName);
            if (idx === -1) return showStatus('Person not found', true);
            const person = people[idx];
            // restore food quantities
            Object.entries(person.orders).forEach(([food, qty]) => {
                const f = foodItems.find(item => item.name === food);
                if (f) f.quantity += qty;
            });
            people.splice(idx, 1);
            renderFood(); renderPeople(); showStatus('Person removed');
        }

        async function assignFood(personName, foodName) {
            try {
                const result = await apiCall('/api/order', { method: 'POST', body: JSON.stringify({ personName, foodName }) });
                people = result.data.people; foodItems = result.data.foodItems;
                renderFood(); renderPeople(); showStatus('Assigned');
            } catch {
                showStatus('Failed to assign', true);
            }
        }

        async function removeOrder(personName, foodName) {
            const person = people.find(p => p.name === personName);
            const qty = person.orders[foodName] || 0;
            if (!qty) return;
            try {
                const result = await apiCall('/api/order', { method: 'DELETE', body: JSON.stringify({ personName, foodName, quantity: qty }) });
                people = result.data.people; foodItems = result.data.foodItems;
                renderFood(); renderPeople(); showStatus('Order removed');
            } catch {
                showStatus('Failed to remove order', true);
            }
        }

        async function toggleComplete(personName) {
            try {
                const result = await apiCall(`/api/people/${encodeURIComponent(personName)}/complete`, { method: 'PATCH' });
                people = result.data.people; foodItems = result.data.foodItems;
                renderPeople(); showStatus('Toggled');
            } catch {
                showStatus('Failed to toggle', true);
            }
        }

        function renderFood() {
            const list = document.getElementById('foodList');
            if (!foodItems.length) { list.innerHTML = '<div class="empty-state">No food items available</div>'; return; }
            list.innerHTML = foodItems.map(f => `
                <div class="food-item ${f.quantity===0?'out-of-stock':''}" draggable="${f.quantity>0}" data-food="${f.name}" ondragstart="startDrag(event)" ondragend="endDrag(event)">
                    <div class="food-name">${f.name}</div><div class="food-quantity">${f.quantity}</div>
                    <button class="delete-food-btn" onclick="deleteFood('${f.name}')">√ó</button>
                </div>
            `).join('');
        }

        function renderPeople() {
            const grid = document.getElementById('peopleGrid');
            if (!people.length) { grid.innerHTML = '<div class="empty-state">No people added yet</div>'; return; }
            grid.innerHTML = people.map(p => {
                const orders = Object.entries(p.orders);
                const orderHtml = orders.length ? orders.map(([f,q]) => `
                    <div class="order-item"><span>${f}</span>
                        <span class="order-quantity">${q}</span>
                        <button class="remove-btn" onclick="removeOrder('${p.name}','${f}')">√ó</button>
                    </div>
                `).join('') : '<div class="empty-state">No orders yet</div>';
                return `
                <div class="person-card" ondrop="drop(event)" ondragover="allowDrop(event)" data-person="${p.name}">
                    <div class="person-header">
                        <div class="person-name">${p.name}</div>
                        <button class="delete-person-btn" onclick="removePerson('${p.name}')">√ó</button>
                    </div>
                    <div class="person-orders">${orderHtml}</div>
                    <button class="complete-btn" onclick="toggleComplete('${p.name}')">${p.completed?'Reopen':'Complete'} Order</button>
                </div>`;
            }).join('');
        }

        function startDrag(e) { e.dataTransfer.setData('text/plain', e.currentTarget.dataset.food); }
        function endDrag(e) { }
        function allowDrop(e) { e.preventDefault(); }
        function drop(e) { e.preventDefault(); const p = e.currentTarget.dataset.person; const f = e.dataTransfer.getData('text/plain'); if (p && f) assignFood(p,f); }

        function showStatus(msg, err=false) { const s = document.getElementById('status'); s.textContent = msg; s.className = `status ${err?'error':''} show`; setTimeout(()=>s.classList.remove('show'),3000); }
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
