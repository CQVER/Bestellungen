<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Food Ordering System</title>
  <style>
    /* ‚Ä¶ Dein komplettes CSS wie gehabt ‚Ä¶ */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
    .container { max-width:1400px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:20px; padding:30px; box-shadow:0 20px 40px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#2c3e50; margin-bottom:30px; font-size:2.5em; text-shadow:2px 2px 4px rgba(0,0,0,0.1); }
    .section { margin-bottom:30px; padding:20px; background:#f8f9fa; border-radius:15px; border-left:5px solid #3498db; }
    .section h2 { color:#2c3e50; margin-bottom:15px; font-size:1.5em; }
    .input-group { display:flex; gap:10px; margin-bottom:15px; align-items:center; }
    input[type="text"], input[type="number"] { padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; transition:border-color 0.3s ease; }
    input:focus { outline:none; border-color:#3498db; }
    input[type="text"] { flex:1; }
    input[type="number"] { width:80px; }
    button { padding:12px 20px; background:linear-gradient(45deg,#3498db,#2980b9); color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:bold; transition:transform 0.2s ease; }
    button:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(52,152,219,0.4); }
    .main-content { display:grid; grid-template-columns:1fr 2fr; gap:30px; margin-top:20px; }
    .food-list, .people-grid { max-height:400px; overflow-y:auto; padding-right:10px; }
    .food-item, .order-item { display:flex; justify-content:space-between; align-items:center; padding:15px; border-radius:10px; cursor:grab; user-select:none; transition:all 0.3s ease; }
    .food-item { background:linear-gradient(45deg,#e74c3c,#c0392b); color:white; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    .food-item.dragging { opacity:0.5; transform:rotate(5deg); }
    .food-item.out-of-stock { background:linear-gradient(45deg,#95a5a6,#7f8c8d); cursor:not-allowed; }
    .person-card { background:#fff; border-radius:15px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,0.1); border:3px dashed #ddd; transition:all 0.3s ease; min-height:200px; }
    .person-card.drag-over { border-color:#3498db; background:#e8f4fd; transform:scale(1.02); }
    .person-card.completed { background:#f8f9fa; opacity:0.7; border-color:#95a5a6; }
    .complete-btn { background:linear-gradient(45deg,#27ae60,#2ecc71); color:white; border:none; border-radius:8px; padding:8px 16px; cursor:pointer; font-size:14px; font-weight:bold; margin-top:10px; transition:all 0.3s ease; }
    .complete-btn.completed { background:linear-gradient(45deg,#f39c12,#e67e22); }
    .empty-state { color:#7f8c8d; font-style:italic; text-align:center; padding:20px; }
    @media (max-width:768px) {
      .main-content { grid-template-columns:1fr; }
      .input-group { flex-direction:column; align-items:stretch; }
      .people-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üçï Bestellungen</h1>

    <div class="section">
      <h2>Add People</h2>
      <div class="input-group">
        <input type="text" id="personName" placeholder="Enter person's name" />
        <button onclick="addPerson()">Add Person</button>
      </div>
    </div>

    <div class="section">
      <h2>Add Food Items</h2>
      <div class="input-group">
        <input type="text" id="foodName" placeholder="Enter food name" />
        <input type="number" id="foodQuantity" placeholder="Qty" min="1" value="1" />
        <button onclick="addFood()">Add Food</button>
      </div>
    </div>

    <div class="main-content">
      <div class="section">
        <h2>Available Food</h2>
        <div id="foodList" class="food-list">
          <div class="empty-state">No food items added yet</div>
        </div>
      </div>

      <div class="section">
        <h2>People & Orders</h2>
        <div id="peopleGrid" class="people-grid">
          <div class="empty-state">No people added yet</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let people = [];
    let foodItems = [];
    let draggedFood = null;

    // L√§dt initial den State vom Server
    async function loadState() {
      try {
        const res = await fetch('/state');
        const data = await res.json();
        people = data.people || [];
        foodItems = data.foodItems || [];
      } catch (e) {
        console.warn('Kann state nicht laden, starte lokal:', e);
      }
      renderFood();
      renderPeople();
    }

    // Speichert den aktuellen State auf dem Server
    async function saveState() {
      try {
        await fetch('/state', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ people, foodItems }),
        });
      } catch (e) {
        console.error('Speichern fehlgeschlagen:', e);
      }
    }

    function addPerson() {
      const nameInput = document.getElementById("personName");
      const name = nameInput.value.trim();
      if (name && !people.find(p => p.name === name)) {
        people.unshift({ name, orders: {}, completed: false });
        nameInput.value = "";
        renderPeople();
        saveState();
      }
    }

    function addFood() {
      const nameInput = document.getElementById("foodName");
      const quantityInput = document.getElementById("foodQuantity");
      const name = nameInput.value.trim();
      const quantity = parseInt(quantityInput.value);
      if (name && quantity > 0) {
        const existing = foodItems.find(f => f.name === name);
        if (existing) existing.quantity += quantity;
        else foodItems.push({ name, quantity });
        nameInput.value = "";
        quantityInput.value = "1";
        renderFood();
        saveState();
      }
    }

    function renderFood() {
      const el = document.getElementById("foodList");
      if (foodItems.length === 0) {
        el.innerHTML = '<div class="empty-state">No food items added yet</div>';
        return;
      }
      el.innerHTML = foodItems.map(f => `
        <div class="food-item ${f.quantity===0?'out-of-stock':''}"
             draggable="${f.quantity>0}" data-food="${f.name}">
          <span class="food-name">${f.name}</span>
          <span class="food-quantity">${f.quantity}</span>
        </div>
      `).join("");
      document.querySelectorAll(".food-item").forEach(item => {
        item.addEventListener("dragstart", handleDragStart);
        item.addEventListener("dragend", handleDragEnd);
      });
    }

    function renderPeople() {
      const grid = document.getElementById("peopleGrid");
      if (people.length === 0) {
        grid.innerHTML = '<div class="empty-state">No people added yet</div>';
        return;
      }
      const sorted = [...people].sort((a,b)=>a.completed===b.completed?0:a.completed?1:-1);
      grid.innerHTML = sorted.map(p => `
        <div class="person-card ${p.completed?'completed':''}" data-person="${p.name}">
          <div class="person-name">${p.name}</div>
          <div class="person-orders">
            ${Object.keys(p.orders).length===0
              ? '<div class="empty-state">No orders yet</div>'
              : Object.entries(p.orders).map(([food,q])=>`
                  <div class="order-item">
                    <span>${food}</span>
                    <div style="display:flex;align-items:center;gap:10px;">
                      <span class="order-quantity">${q}</span>
                      ${!p.completed?`<button class="remove-btn" onclick="removeOrder('${p.name}','${food}')">√ó</button>`:""}
                    </div>
                  </div>
                `).join("")
            }
            ${Object.keys(p.orders).length>0?`
              <button class="complete-btn ${p.completed?'completed':''}"
                      onclick="toggleOrderComplete('${p.name}')">
                ${p.completed?'‚Ü∂ Undo Complete':'Complete Order'}
              </button>
            `:""}
          </div>
        </div>
      `).join("");
      document.querySelectorAll(".person-card:not(.completed)").forEach(card=>{
        card.addEventListener("dragover", handleDragOver);
        card.addEventListener("drop", handleDrop);
        card.addEventListener("dragenter", handleDragEnter);
        card.addEventListener("dragleave", handleDragLeave);
      });
    }

    function handleDragStart(e) {
      const name = e.target.dataset.food;
      const f = foodItems.find(x=>x.name===name);
      if (f && f.quantity>0) {
        draggedFood = name;
        e.target.classList.add("dragging");
      } else e.preventDefault();
    }
    function handleDragEnd(e) { e.target.classList.remove("dragging"); draggedFood = null; }
    function handleDragOver(e){ e.preventDefault(); }
    function handleDragEnter(e){ e.preventDefault(); e.currentTarget.classList.add("drag-over"); }
    function handleDragLeave(e){ if (!e.currentTarget.contains(e.relatedTarget)) e.currentTarget.classList.remove("drag-over"); }
    function handleDrop(e){
      e.preventDefault();
      e.currentTarget.classList.remove("drag-over");
      if (!draggedFood) return;
      const personName = e.currentTarget.dataset.person;
      const person = people.find(p=>p.name===personName);
      const food = foodItems.find(f=>f.name===draggedFood);
      if (person && food && food.quantity>0) {
        person.orders[draggedFood] = (person.orders[draggedFood]||0) + 1;
        food.quantity--;
        renderFood();
        renderPeople();
        saveState();
      }
    }

    function removeOrder(personName, foodName){
      const person = people.find(p=>p.name===personName);
      const food = foodItems.find(f=>f.name===foodName);
      if (person && person.orders[foodName] && food) {
        person.orders[foodName]--;
        if (person.orders[foodName]===0) delete person.orders[foodName];
        food.quantity++;
        renderFood();
        renderPeople();
        saveState();
      }
    }

    function toggleOrderComplete(personName){
      const person = people.find(p=>p.name===personName);
      if (person) {
        person.completed = !person.completed;
        renderPeople();
        saveState();
      }
    }

    // Enter‚ÄêTasten f√ºr Eingaben
    document.getElementById("personName").addEventListener("keypress", e=>{ if(e.key==="Enter") addPerson(); });
    document.getElementById("foodName").addEventListener("keypress", e=>{ if(e.key==="Enter") addFood(); });
    document.getElementById("foodQuantity").addEventListener("keypress", e=>{ if(e.key==="Enter") addFood(); });

    // Initial aufrufen
    loadState();
  </script>
</body>
</html>
